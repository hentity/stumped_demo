rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    match /trees/{id} {
      allow read: if true;
      allow create: if request.resource.data.keys().hasAll(['rootArgumentId','createdAt']);
      allow update, delete: if id == 'demo1';
    }

    match /arguments/{id} {
      allow read: if true;
      allow create: if id.matches('demo1.*')
                    || request.resource.data.get('generated', false) == true
                    || (request.resource.data.text.size() <= 300
                        && request.resource.data.score == 0);
      allow update: if id.matches('demo1.*')
                    || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['score', 'forCount', 'againstCount', 'deleted']);
      allow delete: if true;
    }

    match /sources/{id} {
      allow read: if true;
      allow create: if request.resource.data.url is string;
      allow update, delete: if false;
    }

    match /votes/{id} {
      allow read: if true;
      allow write: if true;
    }
  }
}
